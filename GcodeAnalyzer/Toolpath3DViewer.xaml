<UserControl x:Class="GcodeAnalyzer.Toolpath3DViewer"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:GcodeAnalyzer"
             xmlns:h="http://helix-toolkit.org/wpf"
             Background="#FF1E1E1E"
             Loaded="UserControl_Loaded"
             Focusable="True"
             PreviewKeyDown="UserControl_PreviewKeyDown">
    
    <UserControl.Resources>
        <!-- Dark theme button style for 3D viewer -->
        <Style TargetType="Button">
            <Setter Property="Background" Value="#FF007ACC"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#FF007ACC"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontFamily" Value="Segoe UI Symbol"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="1" CornerRadius="3" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#FF1C97EA"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#FF005A9E"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Media button style (circular) -->
        <Style x:Key="MediaButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#FF3E3E42"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#FF3F3F46"/>
            <Setter Property="Width" Value="36"/>
            <Setter Property="Height" Value="36"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontFamily" Value="Segoe UI Symbol"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="1" CornerRadius="18">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#FF007ACC"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#FF005A9E"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Play button style (larger) -->
        <Style x:Key="PlayButtonStyle" TargetType="Button" BasedOn="{StaticResource MediaButtonStyle}">
            <Setter Property="Width" Value="44"/>
            <Setter Property="Height" Value="44"/>
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="Background" Value="#FF007ACC"/>
        </Style>
        
        <!-- Slider style for timeline -->
        <Style TargetType="Slider">
            <Setter Property="Foreground" Value="#FF007ACC"/>
        </Style>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- 3D Viewport -->
        <h:HelixViewport3D x:Name="Viewport3D" Grid.Row="0"
                               Background="#FF1E1E1E"
                               ShowCoordinateSystem="True"
                               CoordinateSystemLabelForeground="White"
                               ZoomExtentsWhenLoaded="True"
                               ShowViewCube="True"
                               ViewCubeBackText="Back"
                               ViewCubeFrontText="Front"
                               ViewCubeLeftText="Left"
                               ViewCubeRightText="Right"
                               ViewCubeTopText="Top"
                               ViewCubeBottomText="Bottom"
                               IsPanEnabled="True"
                               IsRotationEnabled="True">
            <!-- Custom lighting setup with controllable directional light -->
            <ModelVisual3D>
                <ModelVisual3D.Content>
                    <Model3DGroup>
                        <!-- Ambient light for base illumination -->
                        <AmbientLight Color="#404040"/>
                        
                        <!-- Main directional light (controllable) -->
                        <DirectionalLight x:Name="MainDirectionalLight" 
                                         Color="White" 
                                         Direction="0,-1,-1"/>
                        
                        <!-- Fill light from opposite side -->
                        <DirectionalLight Color="#606060" 
                                         Direction="0,1,0.5"/>
                    </Model3DGroup>
                </ModelVisual3D.Content>
            </ModelVisual3D>
            
            <!-- Grid on XY plane -->
            <h:GridLinesVisual3D x:Name="GridLines"
                                     Width="200"
                                     Length="200"
                                     MajorDistance="10"
                                     MinorDistance="5"
                                     Thickness="0.05"
                                     Fill="#FF4A4A4A"/>
            
            <!-- Container for toolpath geometry -->
            <ModelVisual3D x:Name="ToolpathContainer"/>
            
            <!-- Container for tool pointer (separate so it renders on top) -->
            <ModelVisual3D x:Name="ToolPointerContainer"/>
        </h:HelixViewport3D>
        
        <!-- View controls overlay -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" 
                    HorizontalAlignment="Right" 
                    VerticalAlignment="Top" 
                    Margin="10">
            <Border Background="#B02D2D30" BorderBrush="#B03F3F46" 
                    BorderThickness="1" CornerRadius="3" Padding="8,5" Margin="0,0,10,0">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Light:" VerticalAlignment="Center" 
                              Foreground="#FFE0E0E0" Margin="0,0,8,0"/>
                    <Slider x:Name="LightAngleSlider" Width="120"
                           Minimum="0" Maximum="360" Value="225"
                           TickFrequency="45" TickPlacement="None"
                           IsSnapToTickEnabled="False"
                           VerticalAlignment="Center"
                           ValueChanged="LightAngleSlider_ValueChanged"/>
                    <TextBlock Text="{Binding Value, ElementName=LightAngleSlider, StringFormat={}{0:F0}&#176;}"
                              VerticalAlignment="Center" Margin="8,0,0,0"
                              Foreground="#FF00D4FF" FontWeight="Bold"
                              MinWidth="35" TextAlignment="Right"/>
                </StackPanel>
            </Border>
            <Button x:Name="BtnResetView" Content="Reset View" 
                    Padding="10,5" Margin="5,0"
                    Click="BtnResetView_Click"/>
            <Button x:Name="BtnTopView" Content="Top" 
                    Padding="10,5" Margin="5,0"
                    Click="BtnTopView_Click"/>
            <Button x:Name="BtnFrontView" Content="Front" 
                    Padding="10,5" Margin="5,0"
                    Click="BtnFrontView_Click"/>
            <Button x:Name="BtnSideView" Content="Side" 
                    Padding="10,5" Margin="5,0"
                    Click="BtnSideView_Click"/>
        </StackPanel>
        
        <!-- Legend -->
        <Border Grid.Row="0" Background="#CC2D2D30" CornerRadius="5" Padding="10"
                HorizontalAlignment="Left" VerticalAlignment="Top" Margin="10"
                BorderBrush="#FF3F3F46" BorderThickness="1">
            <StackPanel>
                <TextBlock Text="Legend" FontWeight="Bold" Foreground="#FFE0E0E0" Margin="0,0,0,5"/>
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <Rectangle Width="20" Height="3" Fill="Orange"/>
                    <TextBlock Text="  Rapid (G0)" Foreground="#FFE0E0E0"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <Rectangle Width="20" Height="3" Fill="DodgerBlue"/>
                    <TextBlock Text="  Linear (G1)" Foreground="#FFE0E0E0"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <Rectangle Width="20" Height="3" Fill="LimeGreen"/>
                    <TextBlock Text="  Arc CW (G2)" Foreground="#FFE0E0E0"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <Rectangle Width="20" Height="3" Fill="MediumPurple"/>
                    <TextBlock Text="  Arc CCW (G3)" Foreground="#FFE0E0E0"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                    <Ellipse Width="12" Height="12" Fill="Yellow"/>
                    <TextBlock Text="  Tool Position" Foreground="#FFE0E0E0"/>
                </StackPanel>
            </StackPanel>
        </Border>
        
        <!-- Current Line Number Display -->
        <Border x:Name="LineNumberDisplay" Grid.Row="1" Background="#CC2D2D30" CornerRadius="5" Padding="15"
                HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="10,10,10,80"
                BorderBrush="#FF3F3F46" BorderThickness="1"
                Visibility="Collapsed">
            <StackPanel>
                <TextBlock Text="Current Line" FontSize="11" Foreground="#FF9E9E9E" 
                           HorizontalAlignment="Center" Margin="0,0,0,2"/>
                <TextBlock x:Name="TxtCurrentLine" Text="1" FontSize="24" FontWeight="Bold" 
                           Foreground="#FF00D4FF" HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
        
        <!-- Simulation Controls (Media Player Style) -->
        <Border x:Name="SimulationControls" Grid.Row="2" 
                Background="#B02D2D30" BorderBrush="#B03F3F46" BorderThickness="0,1,0,0"
                Padding="15,10" Visibility="Collapsed">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Timeline Slider -->
                <Grid Grid.Row="0" Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock x:Name="TxtCurrentTime" Grid.Column="0" 
                               Text="0:00" Foreground="#FFE0E0E0" 
                               VerticalAlignment="Center" Width="50"/>
                    
                    <Slider x:Name="TimelineSlider" Grid.Column="1" 
                            Minimum="0" Maximum="100" Value="0"
                            VerticalAlignment="Center" Margin="10,0"
                            ValueChanged="TimelineSlider_ValueChanged"/>
                    
                    <TextBlock x:Name="TxtTotalTime" Grid.Column="2" 
                               Text="0:00" Foreground="#FFE0E0E0" 
                               VerticalAlignment="Center" Width="50" TextAlignment="Right"/>
                </Grid>
                
                <!-- Control Buttons -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center">
                    <!-- Skip to Start -->
                    <Button x:Name="BtnSkipToStart" Style="{StaticResource MediaButtonStyle}"
                            Content="&#x23EE;" ToolTip="Skip to Start"
                            Click="BtnSkipToStart_Click" Margin="5,0"/>
                    
                    <!-- Previous Line (Step Back) -->
                    <Button x:Name="BtnPreviousLine" Style="{StaticResource MediaButtonStyle}"
                            Content="&#x25C0;" ToolTip="Previous Line"
                            Click="BtnPreviousLine_Click" Margin="5,0"/>
                    
                    <!-- Rewind / Slower -->
                    <Button x:Name="BtnRewind" Style="{StaticResource MediaButtonStyle}"
                            Content="&#x23EA;" ToolTip="Slower"
                            Click="BtnRewind_Click" Margin="5,0"/>
                    
                    <!-- Play/Pause -->
                    <Button x:Name="BtnPlayPause" Style="{StaticResource PlayButtonStyle}"
                            Content="&#x25B6;" ToolTip="Play/Pause"
                            Click="BtnPlayPause_Click" Margin="10,0"/>
                    
                    <!-- Fast Forward / Faster -->
                    <Button x:Name="BtnFastForward" Style="{StaticResource MediaButtonStyle}"
                            Content="&#x23E9;" ToolTip="Faster"
                            Click="BtnFastForward_Click" Margin="5,0"/>
                    
                    <!-- Next Line (Step Forward) -->
                    <Button x:Name="BtnNextLine" Style="{StaticResource MediaButtonStyle}"
                            Content="&#x25B6;" ToolTip="Next Line"
                            Click="BtnNextLine_Click" Margin="5,0"/>
                    
                    <!-- Skip to End -->
                    <Button x:Name="BtnSkipToEnd" Style="{StaticResource MediaButtonStyle}"
                            Content="&#x23ED;" ToolTip="Skip to End"
                            Click="BtnSkipToEnd_Click" Margin="5,0"/>
                    
                    <!-- Speed Display -->
                    <Border Background="#B03E3E42" CornerRadius="3" Padding="8,4" Margin="20,0,0,0"
                            VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Speed: " Foreground="#FF9E9E9E" VerticalAlignment="Center"/>
                            <TextBlock x:Name="TxtSpeed" Text="1x" Foreground="#FFE0E0E0" 
                                       FontWeight="Bold" VerticalAlignment="Center" Width="40"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Simulation Info -->
                    <Border Background="#B03E3E42" CornerRadius="3" Padding="8,4" Margin="10,0,0,0"
                            VerticalAlignment="Center">
                        <TextBlock Text="G-code Simulator" Foreground="#FF9E9E9E" VerticalAlignment="Center"/>
                    </Border>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
